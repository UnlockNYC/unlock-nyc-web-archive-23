<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/styles/site.css">
    <title>Advocate Login: Unlock NYC</title>
    <style>
        body {
            background-color: #23296a;
        }

        #form-page {
            background-color: White;
            padding: 5%;
            width: 85%;
            margin: auto;
            min-width: 500px;
            min-height: 100vh;
        }

        h2 {
            font-size: 18px;
        }

        select#clients {
            border: 1px solid black;
            padding: 10px 18px 10px 18px;
            border-radius: 10px;
            width: 50%;
        }

    </style>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div id="form-page">
        <h1>
            UNLOCK <br> NYC <br>
        </h1>
        <h1>
            ADVOCATE REPORT FORM
        </h1>
        <h2 id="email"></h2>
        <h2 id="org"></h2>
        <form id="advocate-report" action="/.netlify/functions/submit-advocate" method="post"
            enctype="multipart/form-data">
            <select name="client" id="clients-choice">
            </select>
            <p>Is the person that you are reporting on behalf missing from this list? Fill out a <a id="new-user-form"
                    href="https://weunlock.nyc" target="blank">new user enrollment</a> form first, and then return to
                refresh this page.</p>
            <input id="submit-report" type="submit" value="Submit Report"></input>
        </form>
    </div>
    <script>
        $(document).ready(async function () {
            let userToken = JSON.parse(window.localStorage.getItem("gotrue.user")).token;
            let userInfo = JSON.parse(window.localStorage.getItem("gotrue.user"));
            let newUserForm = "https://airtable.com/shrjDxUcmjIdrVtTq?prefill_Organization%20choice=";
            // TEST for now, staging base 

            console.log(userInfo);

            // first load advocate info based on user login token
            $("h2#email").html(userInfo.email);
            $("h2#org").html(userInfo.app_metadata.org)
            $("a#new-user-form").attr("href", `${newUserForm}${userInfo.app_metadata.org}`);

            // call function that queries Airtable for client list 
            let response = await fetch('/.netlify/functions/read-advocate', {
                method: 'POST',
                body: JSON.stringify(userToken),
                headers: {
                    "Content-Type": "application/json"
                }
            });
            let data = await response.json();
            console.log(data)
            let clientList = data.clientList;
            // populate client dropdown options
            for (i = 0; i < clientList.length; i++) {
                $('select#clients-choice').append($('<option>', {value: `${clientList[i].id}`, text: `${clientList[i].name}`}));
            }

            // submit form data
            $("input#submit-report").submit(async function (e) {
                e.preventDefault();
                const formData = new FormData($("form#advocate-report"));
                formBody = {};
                formData.forEach(function (value, key) {
                    formBody[key] = value;
                });

                alert(formBody);

                const response = await fetch('/.netlify/functions/submit-advocate', {
                    method: 'POST',
                    body: JSON.stringify(formBody)
                });
                const data = await response.json();
                console.log(data);
            });

        });
    </script>
</body>

</html>
