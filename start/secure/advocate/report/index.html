<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/styles/site.css">
    <link rel="stylesheet" href="/styles/forms.css">
    <title>Advocate Login: Unlock NYC</title>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjSD4KtZNkPXvMFeuyKLVIV_FdQtfQD34&libraries=places">
    </script>
</head>

<body>
    <div id="form-page">
        <h1>
            UNLOCK <br> NYC <br>
        </h1>
        <h1>
            ADVOCATE REPORT FORM
        </h1>
        <h2 id="email"></h2>
        <h2 id="org"></h2>
        <form id="advocate-report" action="" method="post">
            <label class="form-field" for="client">Who are you reporting on behalf of today?</label>
            <select name="client" id="clients-choice">
            </select>
            <p>Is the person that you are reporting on behalf missing from this list? Fill out a <a id="new-user-form"
                    href="https://weunlock.nyc" target="blank">new user enrollment</a> form first, and then return to
                refresh this page.</p>
            <label class="form-field" for="discriminationType">What type of discrimination are you reporting
                today?</label>
            <select name="discriminationType" id="discriminationType" data-id="fldp0Cdze4QBCRIQy">
                <!--OPTIONS FILLED BY AIRTABLE METADATA API CALL -->
            </select>
            <label class="form-field" for="story">Can you tell us more about what happened?</label>
            <input class="wide-text" type="textarea" id="story" name="story">
            <label class="form-field" for="date">What date did the discrimination happen?</label>
            <input type="date" id="incidentDate" name="incidentDate">
            <label class="form-field" for="reportAddress">What is the building address?</label>
            <input class="wide-text" type="text" id="reportAddress" name="reportAddress" required autocomplete="off">
            <label class="form-field" for="unit">Apartment/Unit number?</label>
            <input type="text" id="unit" name="unit">
            <label class="form-field" for="website">What website did you use to find the apartment?</label>
            <select name="website" id="website" data-id="fldhEdkPi8horzLD4">
                <!--OPTIONS FILLED BY AIRTABLE METADATA API CALL -->
            </select>
            <label class="form-field" for="denialType">Where did the discrimination happen?</label>
            <select name="denialType" id="denialType" data-id="fldZYKk8mQAJe05b5" class="multi">
                <!--OPTIONS FILLED BY AIRTABLE METADATA API CALL -->
            </select>

            <label class="form-field" for="url">What is the URL of the listing?</label>
            <input class="wide-text" type="text" id="url" name="url">
            <label class="form-field" for="available">Is the listing still available?</label>
            <select name="available" id="available" data-id="fldLDDBMmULQ5gI1n">
                <!--OPTIONS FILLED BY AIRTABLE METADATA API CALL -->
            </select>
            <label class="form-field" for="rent">What is the rent of the apartment you were looking at?</label>
            <input type="number" min="1" step="any" name="rent" id="rent">
            <label class="form-field" for="intervention">Is your client interested in a pre-complaint
                intervention?</label>
            <select name="intervention" id="intervention" data-id="fldHfhNDDz7Vgviec">
                <!--OPTIONS FILLED BY AIRTABLE METADATA API CALL -->
            </select>

            <input id="submit-report" type="submit" value="Continue"></input>
        </form>
    </div>
    <script>
        $(document).ready(async function () {

            let userToken = JSON.parse(window.localStorage.getItem("gotrue.user")).token;
            let userInfo = JSON.parse(window.localStorage.getItem("gotrue.user"));
            let newUserForm = "https://airtable.com/shrjDxUcmjIdrVtTq?prefill_Organization%20choice=";
            // TEST for now, staging base 

            // first load advocate info based on user login token
            $("h2#email").html(userInfo.email);
            $("h2#org").html(userInfo.app_metadata.org)
            $("a#new-user-form").attr("href", `${newUserForm}${userInfo.app_metadata.org}`);

            // call function that queries Airtable for client list and column schema
            let response = await fetch('/.netlify/functions/read-advocate', {
                method: 'POST',
                body: JSON.stringify(userToken),
                headers: {
                    "Content-Type": "application/json"
                }
            });
            let data = await response.json();
            let clientList = data.clientList;
            // populate client dropdown options
            for (i = 0; i < clientList.length; i++) {
                $('select#clients-choice').append($('<option>', {value: `${clientList[i].id}`, text: `${clientList[i].name}`}));
            }

            // getting the rest of airtable schema
            let reportSchema = data.schema;
            console.log(reportSchema);

            $("select").each(function () {
                if ($(this).attr("data-id")) {
                    // data-id attribute on select dropdowns match the field IDs from airtable
                    // to join with schema, for selection <options>
                    for (i = 0; i < reportSchema.length; i++) {
                        if ($(this).attr("data-id") == Object.keys(reportSchema[i])[0]) {
                            console.log(reportSchema[i][Object.keys(reportSchema[i])[0]]);
                            let options = JSON.parse(reportSchema[i][Object.keys(reportSchema[i])[0]]);
                            console.log(options);
                            for (j = 0; j < options.length; j++) {
                                if ($(this).hasClass("multi")) {
                                    // for multi select, create checkboxes
                                    let name = $(this).attr("name");
                                    $(this).append($(`<input type='checkbox' name='${name}' value='${options[j].name}' id='${options[j].name}'><label for='${options[j].name}'>${options[j].name}</label>`));
                                } else {
                                    // for single select, create dropdown options
                                    $(this).append($('<option>', {value: `${options[j].name}`, text: `${options[j].name}`}));
                                }
                            }
                        }
                    }
                }
            });

            // Google Maps Places Autcomplete
            // for address input form, code from:
            // https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete-addressform

            let autocomplete;
            let addressField;

            function initAutocomplete() {
                addressField = document.querySelector("#reportAddress");
                // Create the autocomplete object, restricting the search predictions to
                // addresses in New York City
                autocomplete = new google.maps.places.Autocomplete(addressField, {
                    componentRestrictions: {country: ["us"]},
                    fields: ["address_components", "geometry"],
                    types: ["address"],
                });
                const southwest = {lat: 40.4869, lng: -74.32030};
                const northeast = {lat: 40.9365, lng: -73.0017};
                const mapBounds = new google.maps.LatLngBounds(southwest, northeast);
                autocomplete.setBounds(mapBounds);

                //addressField.focus();
                // When the user selects an address from the drop-down, populate the
                // address fields in the form.
                autocomplete.addListener("place_changed", fillInAddress);
            }

            function fillInAddress() {
                // Get the place details from the autocomplete object.
                const place = autocomplete.getPlace();
                let address1 = "";
                let postcode = "";

                console.log(place);

                // Get each component of the address from the place details,
                // and then fill-in the corresponding field on the form.
                // place.address_components are google.maps.GeocoderAddressComponent objects
                // which are documented at http://goo.gle/3l5i5Mr
                for (const component of place.address_components) {
                    // @ts-ignore remove once typings fixed
                    const componentType = component.types[0];

                    switch (componentType) {
                        case "street_number": {
                            address1 = `${component.long_name} ${address1}`;
                            break;
                        }

                        case "route": {
                            address1 += `${component.short_name}, `;
                            break;
                        }

                        case "sublocality_level_1": { /*city*/
                            address1 += `${component.long_name}, `;
                            break;
                        }

                        case "administrative_area_level_1": { /*state*/
                            address1 += `${component.short_name} `;
                            break;
                        }

                        case "postal_code": {
                            postcode = `${component.long_name}${postcode}`;
                            break;
                        }

                        /*case "postal_code_suffix": {
                            postcode = `${postcode}-${component.long_name}`;
                            break;
                        }*/
                        /*case "locality":
                            document.querySelector("#locality").value = component.long_name;
                            break;
                        case "administrative_area_level_1": {
                            document.querySelector("#state").value = component.short_name;
                            break;
                        }
                        case "country": {
                            document.querySelector("#country").value = component.long_name;
                            break;
                            }*/
                    }

                    addressField.value = address1 + postcode;

                    // After filling the form with address components from the Autocomplete
                    // prediction, set cursor focus on the second address line to encourage
                    // entry of subpremise information such as apartment, unit, or floor number.
                    //address2Field.focus();
                }
            }

            //window.initAutocomplete = initAutocomplete;
            initAutocomplete();


            // submit form data
            $("form#advocate-report").submit(async function (e) {
                e.preventDefault();
                let formBody = formToJSON($("form#advocate-report")[0]);
                const response = await fetch('/.netlify/functions/submit-advocate', {
                    method: 'POST',
                    body: formBody
                });
                const data = await response.json();
                if (data.statusCode == 200) {
                    window.location.href = `/start/secure/advocate/report/evidence-submit/index.html?id=${data.record}`
                }

                // turn formData into JSON, stringify for fetch request
                function formToJSON(form) {
                    const formData = new FormData(form);
                    const obj = {};
                    formData.forEach((value, key) => {
                        obj[key] = value;
                    });
                    return JSON.stringify(obj);
                }
            });
        });

    </script>
</body>

</html>
