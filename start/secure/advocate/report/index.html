<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/styles/site.css">
    <title>Advocate Login: Unlock NYC</title>
    <style>
        body {
            background-color: #23296a;
        }

        #form-page {
            background-color: White;
            padding: 5%;
            width: 85%;
            margin: auto;
            min-width: 500px;
            min-height: 100vh;
        }

        h2 {
            font-size: 18px;
        }

        select#clients {
            border: 1px solid black;
            padding: 10px 18px 10px 18px;
            border-radius: 10px;
            width: 50%;
        }

    </style>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div id="form-page">
        <h1>
            UNLOCK <br> NYC <br>
        </h1>
        <h1>
            ADVOCATE REPORT FORM
        </h1>
        <h2 id="email"></h2>
        <h2 id="org"></h2>
        <form id="advocate-report" action="" method="post">
            <select name="client" id="clients-choice">
            </select>
            <p>Is the person that you are reporting on behalf missing from this list? Fill out a <a id="new-user-form"
                    href="https://weunlock.nyc" target="blank">new user enrollment</a> form first, and then return to
                refresh this page.</p>
            <label class="form-field">Address</label>
            <input id="report-address" name="report-address" required autocomplete="off">
            <input id="submit-report" type="submit" value="Continue"></input>
        </form>
    </div>
    <script>
        // Google Maps Places Autcomplete
        // for address input form, code from:
        // https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete-addressform

        let autocomplete;
        let addressField;

        function initAutocomplete() {
            addressField = $("#report-address");
            // Create the autocomplete object, restricting the search predictions to
            // addresses in New York City
            autocomplete = new google.maps.places.Autocomplete(addressField, {
                componentRestrictions: {country: ["us"]},
                fields: ["address_components", "geometry"],
                types: ["address"],
            });
            const southwest = {lat: 40.4869, lng: -74.32030};
            const northeast = {lat: 40.9365, lng: -73.0017};
            const mapBounds = new google.maps.LatLngBounds(southwest, northeast);
            autocomplete.setBounds(mapBounds);

            addressField.focus();
            // When the user selects an address from the drop-down, populate the
            // address fields in the form.
            autocomplete.addListener("place_changed", fillInAddress);
        }

        function fillInAddress() {
            // Get the place details from the autocomplete object.
            const place = autocomplete.getPlace();
            let address1 = "";
            let postcode = "";

            // Get each component of the address from the place details,
            // and then fill-in the corresponding field on the form.
            // place.address_components are google.maps.GeocoderAddressComponent objects
            // which are documented at http://goo.gle/3l5i5Mr
            for (const component of place.address_components) {
                // @ts-ignore remove once typings fixed
                const componentType = component.types[0];

                switch (componentType) {
                    case "street_number": {
                        address1 = `${component.long_name} ${address1}`;
                        break;
                    }

                    case "route": {
                        address1 += component.short_name;
                        break;
                    }

                    case "postal_code": {
                        postcode = `${component.long_name}${postcode}`;
                        break;
                    }

                    case "postal_code_suffix": {
                        postcode = `${postcode}-${component.long_name}`;
                        break;
                    }
                    case "locality":
                        document.querySelector("#locality").value = component.long_name;
                        break;
                    case "administrative_area_level_1": {
                        document.querySelector("#state").value = component.short_name;
                        break;
                    }
                    case "country":
                        document.querySelector("#country").value = component.long_name;
                        break;
                }
            }

            addressField.value = address1 + postcode;

            // After filling the form with address components from the Autocomplete
            // prediction, set cursor focus on the second address line to encourage
            // entry of subpremise information such as apartment, unit, or floor number.
            //address2Field.focus();
        }

        window.initAutocomplete = initAutocomplete;
    </script>
    <script>
        $(document).ready(async function () {
            let userToken = JSON.parse(window.localStorage.getItem("gotrue.user")).token;
            let userInfo = JSON.parse(window.localStorage.getItem("gotrue.user"));
            let newUserForm = "https://airtable.com/shrjDxUcmjIdrVtTq?prefill_Organization%20choice=";
            // TEST for now, staging base 

            // first load advocate info based on user login token
            $("h2#email").html(userInfo.email);
            $("h2#org").html(userInfo.app_metadata.org)
            $("a#new-user-form").attr("href", `${newUserForm}${userInfo.app_metadata.org}`);

            // call function that queries Airtable for client list 
            let response = await fetch('/.netlify/functions/read-advocate', {
                method: 'POST',
                body: JSON.stringify(userToken),
                headers: {
                    "Content-Type": "application/json"
                }
            });
            let data = await response.json();
            let clientList = data.clientList;
            // populate client dropdown options
            for (i = 0; i < clientList.length; i++) {
                $('select#clients-choice').append($('<option>', {value: `${clientList[i].id}`, text: `${clientList[i].name}`}));
            }

            // submit form data
            $("form#advocate-report").submit(async function (e) {
                e.preventDefault();
                let formBody = formToJSON($("form#advocate-report")[0]);
                const response = await fetch('/.netlify/functions/submit-advocate', {
                    method: 'POST',
                    body: formBody
                });
                const data = await response.json();
                if (data.statusCode == 200) {
                    window.location.href = `/start/secure/advocate/report/evidence-submit/index.html?id=${data.record}`
                }

                // turn formData into JSON, stringify for fetch request
                function formToJSON(form) {
                    const formData = new FormData(form);
                    const obj = {};
                    formData.forEach((value, key) => {
                        obj[key] = value;
                    });
                    return JSON.stringify(obj);
                }
            });
        });

    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjSD4KtZNkPXvMFeuyKLVIV_FdQtfQD34&callback=initAutocomplete&libraries=places"
        defer>
        </script>
</body>

</html>
