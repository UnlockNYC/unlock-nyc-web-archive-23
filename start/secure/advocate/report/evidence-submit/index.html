<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/styles/site.css">
    <title>Advocate Login: Unlock NYC</title>
    <style>
        body {
            background-color: #23296a;
        }

        #form-page {
            background-color: White;
            padding: 5%;
            width: 85%;
            margin: auto;
            min-width: 500px;
            min-height: 100vh;
        }

        h2 {
            font-size: 18px;
        }

        select#clients {
            border: 1px solid black;
            padding: 10px 18px 10px 18px;
            border-radius: 10px;
            width: 50%;
        }

    </style>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div id="form-page">
        <h1>
            UNLOCK <br> NYC <br>
        </h1>
        <h1>
            ADVOCATE REPORT FORM
        </h1>
        <h2 id="email"></h2>
        <h2 id="org"></h2>
        <h2>UPLOAD EVIDENCE</h2>
        <form id="advocate-evidence" action="" method="post">
            <label for="files">Select evidence to upload:</label>
            <input type="file" id="files" name="files[]" multiple>
            <input type="submit" value="Add Evidence to Report">
        </form>

    </div>
    <script>
        $(document).ready(async function () {
            let userToken = JSON.parse(window.localStorage.getItem("gotrue.user")).token;
            let userInfo = JSON.parse(window.localStorage.getItem("gotrue.user"));
            // TEST for now, staging base 

            // first load advocate info based on user login token
            $("h2#email").html(userInfo.email);
            $("h2#org").html(userInfo.app_metadata.org)

            // get newly created report ID from URL parameters
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const report = urlParams.get('id');


            // submit form data
            $("form#advocate-evidence").submit(async function (e) {
                e.preventDefault();
                alert("SUBMIT!");
                let formData = new FormData($("form#advocate-evidence")[0]);
                console.log([...formData])
                const response = await fetch('/.netlify/functions/upload-evidence', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                console.log(data);

                // turn formData into JSON, stringify for fetch request
                function formToJSON(form) {
                    const formData = new FormData(form);
                    const obj = {};
                    formData.forEach((value, key) => {
                        obj[key] = value;
                    });
                    return JSON.stringify(obj);
                }
            });
        });

    </script>
</body>

</html>
